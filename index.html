<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>AlCapON by alafon</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">

      <header>
        <h1>AlCapON</h1>
        <p>Give your eZ Publish installation the power of Capistrano</p>

        <p><a href="#features">Features</a> | <a href="#install">Install</a> | <a href="#docs">Doc</a> | <a href="#contribute">Contribute</a></p>

        <p class="view"><a href="https://github.com/alafon/alcapon">View the Project on GitHub <small>alafon/alcapon</small></a></p>

        <ul>
          <li><a href="https://github.com/alafon/alcapon/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/alafon/alcapon/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/alafon/alcapon">View On <strong>GitHub</strong></a></li>
        </ul>

      </header>

      <section>

        <h2>Capistrano recipe for eZ Publish.</h2>
        <p>AlCapON is a simple recipe for Capistrano, the well-known deployment toolbox. It helps you dealing with simple task such as pushing your code to your webserver(s), clearing cache, etc.</p>

        <h3><a name="features">Features</a></h3>
        <p>
          <ul>
            <li>Source code deployment</li>
            <li>Rollback management (source code only)</li>
            <li>Remote database backup</li>
            <li>Local database import</li>
            <li>Storage folders sync. (remote => local only)</li>
            <li>Cache commands</li>
            <li>Autoloads generation</li>
          </ul>
        </p>
        <p>AlCapON has to be installed only <b>once</b> on your system and can be used multiple times with different configuration, depending on each project's needs.</p>

        <h3>How does to it works ?</h3>
        <p>On each of your remote servers, Capistrano will create a tree which looks like this :
            <pre><code>$ tree -L 2 application
application
|-- current -> /path/to/application/releases/20120717151916
|-- releases
|   |-- 20120704165734
|   |-- 20120704183051
|   |-- 20120706135251
|   |-- 20120709074137
|   |-- 20120712083257
|   |-- 20120717151704
|   `-- 20120717151916
`-- shared
    |-- cached-copy
    |-- log
    |-- pids
    |-- system
    `-- var</code></pre>
            <br />/path/to/application/current will be known by your webserver (Apache, Nginx, whatever) as the document root</p>
        <p>Each time you deploy :
            <ul>
                <li>Capistrano creates a dedicated directory in <i>./releases</i></li>
                <li>Then it symlinks ./shared/var into the new release</li>
                <li>Some eZ Publish tasks are then executed to take care of caches, autoloads, ...</li>
                <li>Finally, it updates the ./current symlink in order to target the newly deployed release</li>
            </ul>
        </p>

        <h3>Capistrano requirements</h3>
        <p>Even if the gemspec says that it requires capistrano >= 2.12, it might be
        compatible with older version. If you've successfully used it on such versions
        please fell free to give us some feedback.</p>

        <h4>Note regarding dependencies checks made by the recipe</h4>

        <p>The `deploy:check` task will make sure that the following are installed :
            <ul>
                <li>PHP-CLI</li>
                <li>PHP >= 5.2.14</li>
                <li>Curl PHP extension</li>
            </ul>

            However, it does not check the followings requirements :
            <ul>
                <li>eZ Components (should also check that they are patched according eZ Publish needs)</li>
                <li>other PHP extensions / configuration requirements such as date.timezone in php.ini</li>
                <li>Apache2/Nginx configuration (and required modules activation)</li>
            </ul>
            <br />
            <p>To be honest, I did not investigate more on Capistrano capabilities regarding this kind of features, and it was more a proof of concept. I think that dedicated tasks should be created to really check what we need, so feel free to contribute on this topic.</p>
        </p>

        <h3><a name="install">Installation</a></h3>
        <ul>
          <li>Install Capistrano : see online documentation <a href="https://github.com/capistrano/capistrano/wiki/2.x-Getting-Started">here</a>
          <li>Install the alcapon gem</li>
        </ul>
        <pre><code>$ gem install alcapon</code></pre>

        <h3>Setting it up</h3>
        <h4>Initialisation</h4>
        <p>From /path/to/ezpublish, run</p>
        <pre><code>$ capezit .</code></pre>
        <p>This is a simple initialisation script that will create
          <ul>
            <li>at the eZ Publish root : a <i>Capfile</i> (know makefile or rakefile ? this one has the same purpose)</li>
            <li>in extension/alcapon : sample files you will need to edit later</li>
          </ul>
        </p>

        <h4>Troubleshooting</h4>

        <p>If the capezit or the cap commands are not found on your system, this is more likely that the Ruby's bin directory has not been added to your PATH env. variable. You can do this by editing ~/.bashrc and add this code at the end : <pre><code>PATH=$PATH:/var/lib/gems/1.8/bin
export PATH</code></pre></p>

        <h3>Common configuration file</h3>
        <p>config/deploy.rb  a common file you might find within any Capistrano recipe. It controls default settings known by Capistrano itself. A sample one has been created for you by the <i>capezit</i> command : </p>

<pre><code># Comment this if you don't want to use a multistage setup
set :stages, %w(devel production )
set :default_stage, "devel"
require 'capistrano/ext/multistage'

set :application, "myapp"
set :repository,  "git@github.com:username/myapp.git"

set :deploy_to, "/var/www/#{application}"
# The user connecting your server through ssh
set :user, "deploy"

# The default branch used (can be overridden on multistage setup)
set :branch, "master"

# Need if you want to deploy somewhere where sudo is needed
default_run_options[:pty] = true

# Use this to use your ssh keys
# (you might need to run ssh-add /path/to/your/deploy_key before)
ssh_options[:forward_agent] = true
# Or if you want to use a specific key
#ssh_options[:keys] = %w(/home/username/.ssh/id_rsa)

# Or: `accurev`, `bzr`, `cvs`, `darcs`, `git`, `mercurial`, `perforce`, `subversion` or `none`
set :scm, :git

# Comment this if you don't use submodules
set :git_enable_submodules, 1

# Prevents you from cloning the whole rep. each deploy but your remote servers
# must be able to get connected to your scm server
set :deploy_via, :remote_cache

# Your Primary HTTP server
# (Use config/deploy/*.rb files instead if you need a multisage setup)
role :web, "domain.com", :primary => true
# Another HTTP server, for instanced when using the clustered mode
#role :web, "server2"

#role :db,  "your primary db-server here", :primary => true # This is where Rails migrations will run
#role :db,  "your slave db-server here"
</code></pre>

        <p><b>Important</b> : the multistage ext. is enabled by default. If you don't want to use it, simply comment the first three settings at the top of this file.</p>

        <h3>eZ Publish configuration files</h3>
        <p>Because I did not want to use the default deploy.rb file for eZ Publish related stuff, I putted this in a dedicated one in config/ezpublish.rb</p>

        <pre><code># This file contains eZ Publish adjustable variables depending on your custom setup

# Your webserver user and group, used to chmod directories just after deploy:setup
set :webserver_user, "apache"
set :webserver_group, "apache"

# If true, will always turn your webserver offline
# Requires a specific rewrite rule (see documentation)
set :always_turnoff, false

# Array taking all the values given by php bin/php/ezcache.php --list-tags
#
# If you want to clear all caches use :
#set :cache_list, "all"
set :cache_list, [ "template", "ini", "content" ]

# If true, adds '--purge' to the ezcache.php command
# Be careful with that one, some versions are known to completely delete
# your var directory (2012.5 for instance)
set :cache_purge, false

# Set this if you want to be able to sync your remote shared directory
#set :storage_dir, 'var/ezflow_site/storage'
# Set this to tell Capistrano with which host you want to sync your local storage dir
#set :shared_host, "domain.com"

# Which autoloads to generate. By default, regenerates extensions and
# kernel-override autoloads
# Possible values : see bin/php/ezpgenerateautoloads.php --help
set :autoload_list, [ "extension", "kernel-override" ]

# TODO : use yml files to manage database credentials securely
# See http://www.simonecarletti.com/blog/2009/06/capistrano-and-database-yml/
set :database_uname, "dbuname"
set :database_passd, "dbpasswd"
set :database_name, "dbname"

# Not implemented
set :ezpublish_separated_core, false
set :ezpublish_base, "community"
set :ezpublish_version, "2012.5"

# Check-list (used by cap setup:check)
depend :remote, :command, "php"
depend :remote, :match, "php -r \\"echo(version_compare(PHP_VERSION,'5.2.14')?'ok':'ko');\\"", "ok"
depend :remote, :match, "php -m | grep curl", "curl"

# TODO
#Check : PHP memory_limit >= 128
#Check : PHP date.imezone = "something"
#Check : eZ Components (must be bundled if eZ Publish >= 20??.? since there's a patch for Archive)
#Check : If deploy_via remote_cache => check of the remote servers have access to the scm</code></pre>

        <p>If you use the multisage feature, then you need to create overrides in order to set different settings for each of your environment. Pretty useful isn't it ?<br />
        Fortunately, these files can be generated through a task provided by the multistage ext. (and taking care of the stage names you used in deploy.rb : </p>

        <pre><code>$ cap multistage:prepare</code></pre>

        <p><b>devel.rb</b> example :
<pre><code># This one is used to run command as a specific user with `sudo -u .... command`
set :admin_runner, 'sudoer_user'
set :webserver_user, 'www-data'
set :webserver_group, 'www-data'
set :branch, 'devel'
set :shared_host, 'devel.domain.fr'
role :web, 'devel.domain.fr', :primary => true           # Your Primary HTTP server
role :db,  'devel.domain.fr', :primary => true</code></pre>
        </p>

        <p><b>production.rb</b> example :
        <pre><code># This one is used to run command as a specific user with `sudo -u .... command`
set :admin_runner, 'sudoer_user'
set :webserver_user, 'apache'
set :webserver_group, 'apache'
set :branch, 'master'
set :shared_host, 'www.domain.fr'
role :web, 'www.domain.fr', :primary => true           # Your Primary HTTP server
role :db,  'www.domain.fr', :primary => true</code></pre>
        </p>

        <h3><a name="deploy">Deployment</a></h3>

        <p><b>Important</b> : make sure the users have the needed sudo rights so that the needed command ca be run. For instance, you must give your deployment user (set by :user) the ability to run command as your webserver user :
            <pre><code>Cmnd_Alias DEPLOY_SHELLS  = /bin/mkdir, /bin/chmod, /bin/chown, /bin/chgrp, /bin/ln, /usr/bin/php

user ALL=(user) NOPASSWD: DEPLOY_SHELLS
user ALL=(apache) NOPASSWD: DEPLOY_SHELLS</pre></code>
            so that user can execute command as if he was 'apache'</p>

        <p>See a sudo sample <a href="https://github.com/alafon/alcapon/blob/71451e076dbb0f99d693769429c9d2e5d7ef5d90/docs/sudo_sample">here</a></p>

        <p>If you do not have sudo rights on the target env. you can also tell Capistrano not to use sudo by setting <b>use_sudo</b> to false in one of your config file (deploy.rb or deploy/env.rb) :
            <pre><code>set :use_sudo, false</code></pre></p>

        <p>In order to setup your remote environements, simply run :
            <pre><code>cap deploy:setup</code></pre>
            This will create the needed folders on the remote servers.
        </p>

        <p>If you want, you can run <b>cap deploy:check</b> to be sure that your servers are well configured and meet the requirements (currently, only a few of them are implemented)</p>

        <p>At the end, you just need to execute the deploy task :
            <pre><code>$ cap deploy</code></pre>
            And if you use the multistage ext. don't forget to specify to which environment you want to deploy you eZ Publish website :
            <pre><code>$ cap production deploy</code></pre>
        </p>

        <h3><a name="settings_deployment">Settings Deployment</a></h3>

        <p>You can run basic in-file replacements by setting the <b>file_changes</b>. It's a dead simple associative array which has to be set in a deploy/*.rb file (which defines a certain environment). Here is an example :

            <pre><code>set :file_changes, {
    'settings/override/site.ini.append.php' => {
        'replace' => {
            'SiteURL=devel-www.arnaudlafon.com' => 'SiteURL=www.arnaudlafon.com'
        }
    },
    'settings/override/solr.ini.append.php' => {
        'replace' => {
            'SearchServerURI=http://localhost:8983/solr' => 'SearchServerURI=http://search-server:8983/solr'
        }
    }
}</code></pre>
        </p>

        <p>Because, the system is very basic and only replace a text by another, I'd recommand to use placeholders instead of 'real' values (like in the example above) :
            <pre><code>set :file_changes, {
    'settings/override/site.ini.append.php' => {
        'replace' => {
            'SiteURL=@GLOBAL_SITE_URL@' => 'SiteURL=www.arnaudlafon.com',
            'Database=@DATABASE_NAME@' => 'Database=ezpublish'
        }
    },
    'settings/override/solr.ini.append.php' => {
        'replace' => {
            'SearchServerURI=@SEARCH_SERVER_URI@' => 'SearchServerURI=http://search-server:8983/solr'
        }
    }
}</code></pre></p>

        <p>You can also rename files with the 'rename' action :
            <pre><code>set :file_changes, {
    'settings/override/site.ini.append.dist' => {
        'rename' => 'settings/override/site.ini.append.php',
        'replace' => {
            'SiteURL=@GLOBAL_SITE_URL@' => 'SiteURL=www.arnaudlafon.com',
            'Database=@DATABASE_NAME@' => 'Database=ezpublish'
        }
    }
}</code></pre>

        <p>This is very handy because : <ul>
                <li>you don't have to store password or sensitive data in your SCM anymore</li>
                <li>you can have different configuration for each environment</li>
            </ul>
        </p>

        <p><b>Note that</b> these actions are done every time you deploy your application but you can also run it manually using the <b>cap ezpublish:settings:deploy</b> task</p>

        <h3><a name="docs">Documentation</a></h3>

        <h4>Capistrano tasks dedicated to eZ Publish</h4>

        <p><i>Note : you can list all the available tasks with <b>cap -vT</b></i></p>

        <table>
            <tr>
                <th>task</th>
                <th>definition</th>
                <th>comments</th>
            </tr>
            <tr>
                <td>cap ezpublish:autoloads:generate</td>
                <td># Generates autoloads (extensions and kernel ove...</td>
            </tr>
            <tr>
                <td>cap ezpublish:cache:clear</td>
                <td># Clear caches the way it is configured in ezpub...</td>
            </tr>
            <tr>
                <td>cap ezpublish:dev:local_check</td>
                <td># Checks if there are local changes or not (only...</td>
            </tr>
            <tr>
                <td>cap ezpublish:var:init_shared</td>
                <td># Creates the needed folder within your remote(s...</td>
            </tr>
            <tr>
                <td>cap ezpublish:var:link</td>
                <td># Link .../shared/var into ../releases/[latest_r...</td>
            </tr>
            <tr>
                <td>cap ezpublish:var:sync_to_local</td>
                <td># Sync your var directory with a remote one</td>
            </tr>
            <tr>
                <td>cap ezpublish:var:sync_to_remote</td>
                <td># Sync your remote var folder with local data</td>
            </tr>            
        </table>

        <h3><a name="todolist">Todo List</a></h3>

        <ul>
            <li>Auto-update : because the gem is currently under development, it should be able to check if a new version is available and inform the user how to upgrade its current alcapon gem</li>
            <li>Rollbacks should be able to reimport the old database</li>
            <li>Prevent the usage of --purge on 2012.4 and 2012.5 to prevent storage from being completely removed from the filesystem...</li>
            <li>More dependencies checks when using the task deploy:check</li>
            <li>Enhancements in the var:fix_permission task</li>
            <li>Add unit tests</li>
        </ul>

        <h3><a name="bugs">Known bugs</a></h3>

        <h4>Symlink usage</h4>
        <p>Having the var directory being a symlink to somewhere else seems to prevent the cache from working properly, see <a href="http://pwet.fr/blog/symlink_to_the_ez_publish_var_directory_a_good_idea" target="_blank">http://pwet.fr/blog/symlink_to_the_ez_publish_var_directory_a_good_idea</a> for a good explanation on the issue.<br />
        Following a recent discussion with <a href="http://github.com/dpobel" class="user-mention">Damien</a>, I think that only symlinking the 'storage' folders within var/ should be enough... This also means that var/[^/]/cache will be generated in all the release folders (and we will need to purge them with a dedicated task I think)</p>
        <p><b>UPDATE 2012-08-16 : </b> this should have been fixed in the latest version. var/ is not fully symlink anymore, only the var/[^/]/storage directories are symlinked ; cache & logs are now generated in the release itself.</ob>

        <h3><a name="contribute">Contributing to AlCapON</a></h3>
        <ul>
            <li>fork this repo on Github</li>
            <li>clone your own fork in /somewhere/alcapon</li>
            <li>hack your Capfile and replace <b>load Gem.find_files('capez.rb').last.to_s</b> by <b>load '/somewhere/alcapon/lib/capez.rb'</b><br />
                This way you can test what you do without building the gem everytime</li>
            <li>If you want to rebuild AlCapON, simply use <b>gem build alcapon.gemspec</b> and then install your local version with <b>gem install ./alcapon-X.Y.Z.gem</b>
            <li>create a branch for each of your pull request (feel free to rebase your code first)</li>
            <li>send me a pull request</li>
        </ul>
        <p><i>Contributing to the current page is also muchly appreciated :)</i></p>

        <h3><a name="contributors">Authors and Contributors</a></h3>
        <p><ul>
            <li>Author : <a href="https://github.com/alafon">alafon</a></li>
            <li>Contributors : <a href="https://github.com/francescor">francescor</a></li>
        </ul></p>

        <h3>Support or Contact</h3>
        <p>Having trouble with Pages? Check out the documentation at <a href="http://help.github.com/pages">http://help.github.com/pages</a> or contact <a href="mailto:support@github.com">support@github.com</a> and we’ll help you sort it out.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/alafon">alafon</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7659605-8']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </body>
</html>
